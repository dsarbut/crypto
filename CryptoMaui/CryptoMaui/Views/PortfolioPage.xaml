<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CryptoMaui.Views.PortfolioPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:CryptoMaui.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewModels="clr-namespace:CryptoMaui.ViewModels"
    xmlns:views="clr-namespace:CryptoMaui.Views"
    x:DataType="viewModels:PortfolioViewModel"
    Background="{x:StaticResource Primary}"
    Shell.FlyoutBehavior="Disabled"
    Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <converters:RoiToStringConverter x:Key="RoiStringConverter" />
        <converters:RoiToColorConverter x:Key="RoiColorConverter" Gain="LawnGreen" />
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <Grid Margin="16" RowDefinitions="300, 10, *">
        <CarouselView
            Grid.Row="0"
            Margin="0,50,0,0"
            Background="{StaticResource Primary}"
            HorizontalOptions="Center"
            IndicatorView="indicator"
            ItemsSource="{Binding Dcas}"
            Loop="False"
            PeekAreaInsets="50"
            VerticalOptions="Center">
            <CarouselView.ItemsLayout>
                <LinearItemsLayout Orientation="Horizontal" />
            </CarouselView.ItemsLayout>
            <CarouselView.ItemTemplate>
                <DataTemplate x:DataType="viewModels:DcaViewModel">
                    <VerticalStackLayout HorizontalOptions="Fill">
                        <Label
                            FontSize="20"
                            HorizontalOptions="Center"
                            Text="{Binding CoinName}" />
                        <Label
                            Margin="0,0,0,10"
                            FontSize="14"
                            HorizontalOptions="Center"
                            Text="{Binding TotalCoin, StringFormat='({0:F7})'}"
                            TextColor="{x:StaticResource Gray300}" />
                        <Label HorizontalOptions="Center" Text="{Binding Dca, StringFormat='Dca: {0:F3} $'}" />
                        <Label HorizontalOptions="Center" Text="{Binding TotalInvestment, StringFormat='Initial Investment: {0:F2} $'}" />
                        <Label HorizontalOptions="Center" Text="{Binding ValueToday, StringFormat='Value Today: {0:F2} $'}" />
                        <Label
                            HorizontalOptions="Center"
                            Text="{Binding RoiRate, Converter={x:StaticResource RoiStringConverter}}"
                            TextColor="{Binding RoiRate, Converter={x:StaticResource RoiColorConverter}}" />
                    </VerticalStackLayout>
                </DataTemplate>
            </CarouselView.ItemTemplate>
        </CarouselView>

        <IndicatorView
            x:Name="indicator"
            Grid.Row="1"
            HorizontalOptions="Center"
            IndicatorColor="{x:StaticResource Gray300}"
            IndicatorsShape="Square"
            SelectedIndicatorColor="{x:StaticResource Tertiary}" />


        <CollectionView
            Grid.Row="2"
            CanReorderItems="False"
            ItemSizingStrategy="MeasureAllItems"
            ItemsSource="{Binding Investments}">
            <CollectionView.Header>
                <Label
                    Margin="10"
                    IsVisible="{Binding HasItems}"
                    Text="Investments:" />
            </CollectionView.Header>
            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Start">
                    <ActivityIndicator
                        BackgroundColor="Transparent"
                        HeightRequest="40"
                        IsRunning="{Binding IsLoading}"
                        IsVisible="{Binding IsLoading}"
                        WidthRequest="40"
                        Color="{StaticResource Tertiary}" />
                    <Label
                        HorizontalOptions="Center"
                        IsVisible="{Binding IsLoading, Converter={x:StaticResource InvertedBoolConverter}}"
                        Text="No investments in your portfolio. Add an investment."
                        VerticalOptions="Start" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <VerticalStackLayout
                        Padding="0"
                        x:DataType="viewModels:InvestmentViewModel"
                        Spacing="0">
                        <Border
                            BackgroundColor="{x:StaticResource Secondary}"
                            Stroke="{x:StaticResource Secondary}"
                            StrokeShape="RoundRectangle 10,10,10,10">
                            <Grid
                                Margin="10,0,10,0"
                                HorizontalOptions="Fill"
                                RowDefinitions="*, 10"
                                VerticalOptions="Fill">

                                <CollectionView ItemSizingStrategy="MeasureAllItems" ItemsSource="{Binding CoinDatas}">
                                    <CollectionView.Header>
                                        <Grid
                                            Margin="0,0,0,10"
                                            ColumnDefinitions="*, 100"
                                            HeightRequest="40"
                                            HorizontalOptions="Fill"
                                            RowDefinitions="40"
                                            VerticalOptions="Fill">
                                            <Label
                                                Grid.Row="0"
                                                Grid.Column="0"
                                                FontAttributes="Bold"
                                                FontSize="20"
                                                HorizontalOptions="Start"
                                                Text="{Binding Date, StringFormat='{0:MMMM} {0:yyyy}'}"
                                                VerticalOptions="Center" />

                                            <Label
                                                Grid.Row="0"
                                                Grid.Column="1"
                                                FontAttributes="Bold"
                                                FontSize="20"
                                                HorizontalOptions="End"
                                                Text="{Binding InvestedAmmount, StringFormat='{0:F2} $'}"
                                                VerticalOptions="Center" />
                                        </Grid>
                                    </CollectionView.Header>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="viewModels:CoinDataViewModel">
                                            <Grid ColumnDefinitions="40, *, 100" RowDefinitions="20">
                                                <Label
                                                    Grid.Column="0"
                                                    HorizontalOptions="Start"
                                                    Text="{Binding CoinName}"
                                                    VerticalOptions="Center" />

                                                <Label
                                                    Grid.Column="1"
                                                    HorizontalOptions="Fill"
                                                    HorizontalTextAlignment="Center"
                                                    LineBreakMode="NoWrap"
                                                    VerticalOptions="Center">
                                                    <Label.Text>
                                                        <MultiBinding StringFormat="{}1 {0} = {1:F2}$">
                                                            <Binding Path="CoinName" />
                                                            <Binding Path="BuyingPrice" />
                                                        </MultiBinding>
                                                    </Label.Text>
                                                </Label>

                                                <Label
                                                    Grid.Column="2"
                                                    HorizontalOptions="End"
                                                    Text="{Binding InvestmentValue, StringFormat='{0:F2} $'}"
                                                    VerticalOptions="Center" />
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                        <BoxView BackgroundColor="Transparent" HeightRequest="10" />
                    </VerticalStackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Image
            Grid.Row="2"
            Margin="0,0,10,10"
            HeightRequest="60"
            HorizontalOptions="End"
            Opacity="0.9"
            Source="fab_add.png"
            VerticalOptions="End"
            WidthRequest="60">
            <Image.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding AddInvestmentCommand}" />
            </Image.GestureRecognizers>
            <Image.Behaviors>
                <toolkit:AnimationBehavior AnimateOnTap="True">
                    <toolkit:AnimationBehavior.AnimationType>
                        <toolkit:FadeAnimation Opacity="0.5" />
                    </toolkit:AnimationBehavior.AnimationType>
                </toolkit:AnimationBehavior>
            </Image.Behaviors>
        </Image>
    </Grid>
</ContentPage>
